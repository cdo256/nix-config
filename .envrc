use_sops() {
    local path=${1:-$PWD/secrets/secrets.yaml}
    nix build nixpkgs#sops --print-out-paths --out-link ./results/sops
    local sops='./results/sops/bin/sops'
    local hostname=`hostname`
    eval $($sops -d --extract '["environment"]' --output-type dotenv "$path" | direnv dotenv bash /dev/stdin)
    # Note quotes are still borked.
    eval $($sops -d --extract "[\"restic\"][\"$hostname\"][\"key\"]" "$path" | sed "s/'/\\'/g"| sed 's/"/\\"/g' | sed 's/^/RESTIC_PASSWORD=/' | sed 's/$/\"/' | direnv dotenv bash /dev/stdin)
    eval $($sops -d --extract "[\"restic\"][\"$hostname\"][\"url\"]" "$path" | sed "s/'/\\'/g"| sed 's/"/\\"/g' | sed 's/^/RESTIC_REPOSITORY=\"/' | sed 's/$/\"/' | direnv dotenv bash /dev/stdin)
    watch_file "$path"
}

use flake
use sops
